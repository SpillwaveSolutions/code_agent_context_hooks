# Fast CI Pipeline for CCH (Claude Code Hooks)
#
# This workflow provides rapid feedback during daily development:
# - Formatting check (rustfmt)
# - Linting (clippy)
# - Unit tests
# - Linux IQ smoke test
# - Code coverage (informational)
#
# Target time: ~2-3 minutes
#
# For full IQ/OQ/PQ validation, see validation.yml (runs on PRs to main)

name: Fast CI

on:
  push:
    branches: [develop, "feature/**", "fix/**", "docs/**"]
  pull_request:
    branches: [develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Format check (~30s)
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all --check

  # Linting with clippy (~1 min)
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # Unit tests (~1 min)
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run unit tests
        run: cargo test --lib

  # Linux IQ smoke test (~1 min)
  test-iq-smoke:
    name: IQ Smoke Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run IQ tests
        run: cargo test iq_ -- --nocapture

  # Code coverage (informational, ~2 min)
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Set up Python (for validators)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Generate coverage report
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
      - name: Check coverage threshold
        run: |
          COVERAGE=$(cargo llvm-cov --all-features --workspace --text 2>/dev/null | grep -E "^TOTAL" | awk '{print $NF}' | tr -d '%')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "::warning::Coverage is below 80% threshold: $COVERAGE%"
          fi
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: lcov.info

  # Summary job that requires all others to pass
  ci-success:
    name: Fast CI Success
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test-unit, test-iq-smoke]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.fmt.result }}" != "success" ]] || \
             [[ "${{ needs.clippy.result }}" != "success" ]] || \
             [[ "${{ needs.test-unit.result }}" != "success" ]] || \
             [[ "${{ needs.test-iq-smoke.result }}" != "success" ]]; then
            echo "One or more Fast CI jobs failed"
            exit 1
          fi
          echo "All Fast CI jobs passed successfully"
